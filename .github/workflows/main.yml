name: Build RTweaked Engine

on: 
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download 88MB API Engine
        run: |
          curl -L -o libRobloxLib.dylib https://github.com/adamjogkins-eng/RTweaked/releases/download/v1/libRobloxLib.dylib
          
      - name: Hunt for Symbols
        run: |
          echo "--- START SYMBOL HUNT ---"
          nm -gU libRobloxLib.dylib | grep -Ei "exec|lua|run" || echo "No symbols found"
          echo "--- END SYMBOL HUNT ---"

      - name: Compile RTweaked Menu
        run: |
          # The key flags here are:
          # -Wl,-ld_classic : Forces the use of the older, less strict linker
          # -Wl,-no_fixup_chains : Disables the modern iOS 15+ fixup requirement
          # -Wl,-undefined,dynamic_lookup : Allows linking even if symbols aren't visible yet
          
          xcrun -sdk iphoneos clang++ -dynamiclib -arch arm64 \
          -fobjc-arc -O3 \
          -L. -lRobloxLib \
          -Wl,-ld_classic \
          -Wl,-no_fixup_chains \
          -Wl,-undefined,dynamic_lookup \
          iOSStrap.mm -o iOSStrap.dylib \
          -framework UIKit -framework Foundation -framework QuartzCore
          
      - name: Upload Finished Dylib
        uses: actions/upload-artifact@v4
        with:
          name: RTweaked-Compiled
          path: iOSStrap.dylib
