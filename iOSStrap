#import <UIKit/UIKit.h>
#import <AudioToolbox/AudioToolbox.h>

// --- UI COMPONENTS ---
@interface iOSStrapMenu : UIView
@property (nonatomic, strong) UIVisualEffectView *blurView;
@end

@implementation iOSStrapMenu
- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        self.layer.cornerRadius = 25;
        self.clipsToBounds = YES;
        self.layer.borderWidth = 1.0;
        self.layer.borderColor = [UIColor colorWithWhite:1.0 alpha:0.2].CGColor;

        // Glassmorphism (Frosted Glass)
        UIBlurEffect *blurEffect = [UIBlurEffect effectWithStyle:UIBlurEffectStyleDark];
        _blurView = [[UIVisualEffectView alloc] initWithEffect:blurEffect];
        _blurView.frame = self.bounds;
        [self addSubview:_blurView];

        UILabel *title = [[UILabel alloc] initWithFrame:CGRectMake(0, 10, frame.size.width, 30)];
        title.text = @"iOSStrap Admin";
        title.textColor = [UIColor cyanColor];
        title.textAlignment = NSTextAlignmentCenter;
        title.font = [UIFont boldSystemFontOfSize:18];
        [_blurView.contentView addSubview:title];

        // Dragging Logic for the Menu itself
        UIPanGestureRecognizer *pan = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(handlePan:)];
        [self addGestureRecognizer:pan];

        // Adding 6 Admin Toggles
        NSArray *cmds = @[@"Speed Hack", @"Infinite Jump", @"Fly Mode", @"No Clip", @"Auto Click", @"Anti-AFK"];
        for (int i = 0; i < cmds.count; i++) {
            [self addToggle:cmds[i] y:50 + (i * 45)];
        }
    }
    return self;
}

- (void)addToggle:(NSString *)name y:(CGFloat)y {
    UILabel *lbl = [[UILabel alloc] initWithFrame:CGRectMake(20, y, 140, 30)];
    lbl.text = name;
    lbl.textColor = [UIColor whiteColor];
    lbl.font = [UIFont systemFontOfSize:14];
    [_blurView.contentView addSubview:lbl];

    UISwitch *sw = [[UISwitch alloc] initWithFrame:CGRectMake(self.frame.size.width - 70, y, 50, 30)];
    sw.onTintColor = [UIColor systemBlueColor];
    [sw addTarget:self action:@selector(swTapped:) forControlEvents:UIControlEventValueChanged];
    [_blurView.contentView addSubview:sw];
}

- (void)swTapped:(UISwitch *)sender {
    // Haptics (Light Impact)
    UIImpactFeedbackGenerator *gen = [[UIImpactFeedbackGenerator alloc] initWithStyle:UIImpactFeedbackStyleLight];
    [gen impactOccurred];
}

- (void)handlePan:(UIPanGestureRecognizer *)p {
    CGPoint loc = [p locationInView:self.superview];
    self.center = loc;
}
@end

// --- DRAGGABLE CIRCLE BUTTON ---
@interface FloatingButton : UIButton
@end
@implementation FloatingButton
- (void)touchesMoved:(NSSet*)t withEvent:(UIEvent*)e {
    self.center = [[t anyObject] locationInView:self.superview];
}
@end

// --- GLOBAL SETUP ---
static iOSStrapMenu *menu;
__attribute__((constructor))
static void initialize() {
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, 5 * NSEC_PER_SEC), dispatch_get_main_queue(), ^{
        UIWindow *win = [UIApplication sharedApplication].keyWindow;
        
        // Setup Menu (Hidden)
        menu = [[iOSStrapMenu alloc] initWithFrame:CGRectMake(win.center.x-130, 150, 260, 320)];
        menu.hidden = YES;
        [win addSubview:menu];

        // Setup Floating "B" Circle
        FloatingButton *btn = [FloatingButton buttonWithType:UIButtonTypeCustom];
        btn.frame = CGRectMake(20, 200, 60, 60);
        btn.backgroundColor = [UIColor colorWithRed:0.0 green:0.5 blue:1.0 alpha:0.9];
        btn.layer.cornerRadius = 30;
        [btn setTitle:@"B" forState:UIControlStateNormal];
        btn.titleLabel.font = [UIFont boldSystemFontOfSize:24];
        [btn addTarget:self action:@selector(toggleMenu) forControlEvents:UIControlEventTouchUpInside];
        [win addSubview:btn];
    });
}

static void toggleMenu() {
    menu.hidden = !menu.hidden;
    // Haptics (Medium Impact) for opening menu
    UIImpactFeedbackGenerator *gen = [[UIImpactFeedbackGenerator alloc] initWithStyle:UIImpactFeedbackStyleMedium];
    [gen impactOccurred];
}
